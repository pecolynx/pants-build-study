# pants-build-study

## 006. 

Add the below line to `pants.toml` file.

```
enable_resolves = true
```

```toml
cat <<EOF > pants.toml
[GLOBAL]
pants_version = "2.17.0"

backend_packages = [
    "pants.backend.python",
    "pants.backend.codegen.protobuf.python",
    "pants.backend.docker",
]

[python]
interpreter_constraints = [">=3.11,<3.12"]
enable_resolves = true

[source]
root_patterns = [
    "/src/python/*",
    "/src/protos",
]
EOF
```

```
pants generate-lockfiles ::
```

**Output:**

```
-resolution/#dealing-with-dependency-conflicts
 
 The conflict is caused by:
     The user requested pendulum<3.0.0 and >=2.1.2
     The user requested pendulum==2.0.4
 
 To fix this you could try to:
 1. loosen the range of package versions you've specified
 2. remove package versions to allow pip attempt to solve the dependency conflict
```

Use lockfile to specify version for each application.

https://www.pantsbuild.org/docs/python-lockfiles


```toml
cat <<EOF > pants.toml
[GLOBAL]
pants_version = "2.17.0"

backend_packages = [
    "pants.backend.python",
    "pants.backend.codegen.protobuf.python",
    "pants.backend.docker",
]

[python]
interpreter_constraints = [">=3.11,<3.12"]
enable_resolves = true
default_resolve = "default"

[python.resolves]
default = "3rdparty/python/default.lock"
old_app = "3rdparty/python/old_app.lock"

[source]
root_patterns = [
    "/src/python/*",
    "/src/protos",
]
EOF
```

Add `resolve="old_app",` to `poetry_requirements` target in `src/python/old-app/BUILD` file.

```
cat <<EOF > src/python/old-app/BUILD
poetry_requirements(
    name="poetry",
    resolve="old_app",
)

python_sources(
    name="src",
    dependencies=[
        "src/python/old-app/old_app/**/*.py",
    ]
)

pex_binary(
    name="old-app",
    entry_point="old_app/main.py",
    dependencies=[
        ":src",
    ],
)
EOF
```

**Output:**
```
23:19:04.55 [INFO] Completed: Generate lockfile for default
23:19:17.80 [INFO] Completed: Generate lockfile for old_app
23:19:17.81 [INFO] Wrote lockfile for the resolve `default` to 3rdparty/python/default.lock
23:19:17.81 [INFO] Wrote lockfile for the resolve `old_app` to 3rdparty/python/old_app.lock
```

`3rdparty/pyhon/default.lock` and `3rdparty/pyhon/old_app.lock` were created.

The below is the header of `3rdparty/pyhon/default.lock` file.

```t
// This lockfile was autogenerated by Pants. To regenerate, run:
//
//    pants generate-lockfiles --resolve=default
//
// --- BEGIN PANTS LOCKFILE METADATA: DO NOT EDIT OR REMOVE ---
// {
//   "version": 3,
//   "valid_for_interpreter_constraints": [
//     "CPython<3.12,>=3.11"
//   ],
//   "generated_with_requirements": [
//     "grpc-stubs<2.0.0,>=1.53.0.3",
//     "grpcio<2.0.0,>=1.59.0",
//     "pendulum<3.0.0,>=2.1.2",
//     "protobuf<5.0.0,>=4.24.4"
//   ],
//   "manylinux": "manylinux2014",
//   "requirement_constraints": [],
//   "only_binary": [],
//   "no_binary": []
// }
// --- END PANTS LOCKFILE METADATA ---
```

The below is the header of `3rdparty/pyhon/old_app.lock` file.


```t
// This lockfile was autogenerated by Pants. To regenerate, run:
//
//    pants generate-lockfiles --resolve=old_app
//
// --- BEGIN PANTS LOCKFILE METADATA: DO NOT EDIT OR REMOVE ---
// {
//   "version": 3,
//   "valid_for_interpreter_constraints": [
//     "CPython<3.12,>=3.11"
//   ],
//   "generated_with_requirements": [
//     "pendulum==2.0.4"
//   ],
//   "manylinux": "manylinux2014",
//   "requirement_constraints": [],
//   "only_binary": [],
//   "no_binary": []
// }
// --- END PANTS LOCKFILE METADATA ---
```

```
pants package ::
```
